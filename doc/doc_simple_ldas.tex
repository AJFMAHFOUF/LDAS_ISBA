\documentclass[12pt]{article}
\usepackage{graphicx,rotate,color,amsmath,ametsoc}
\usepackage[latin1]{inputenc}
\usepackage{hyperref}
%\usepackage[francais]{babel}
\setlength{\textwidth}{18.2cm}
\setlength{\textheight}{24cm} % define A4 page
\hoffset=-2.4cm \voffset=-3.1cm % center output on A4 page
\newcommand{\pd}[2]{\frac{\partial #1}{\partial #2}} 
\newcommand{\be}{\begin{equation}}
\newcommand{\ee}{\end{equation}}
\newcommand{\bef}{\begin{figure}}
\newcommand{\enf}{\end{figure}}
\newcommand{\bc}{\begin{center}}
\newcommand{\ec}{\end{center}}
\newcommand{\pp}{\mathcal{P}}
\newcommand{\etal}{{\it et al.} }
\begin{document}
\title{Documentation of a Simple Land Data Assimilation System (SLDAS)}
\author{Jean-Fran\c cois MAHFOUF}
\date{20 January 2024}
\maketitle
\section{Introduction}
A simple land data assimilation system (SLDAS) has been designed
to evaluate the behavior of various assimilation techniques at local scale
using the land surface scheme ISBA described in Noilhan and Mahfouf (1996)
and simulated observations (so-called "twin experiments"). 
Such experimental set-up allows to understand rather easily 
the results obtained since the solution of the inversion problem is known.
\section{Main features of the system}
The experimental set-up consists of three main items:
\begin{itemize}
\item A {\it reference simulation} ({\tt REF}) is performed to generate 
"simulated observations" and to define the truth that the assimilation
runs should reach. 
This corresponds to a standard integration of the
ISBA scheme that needs to be initialized for its prognostic variables
and forced by prescribed atmospheric quantities (wind, temperature,
humidity, radiation fluxes, precipitation fluxes). The land surface
characteristics for the soil and the vegetation have also to be specified.
\item An {\it open loop run} ({\tt OL}) : this run is similar to the {\tt REF} run except
that the initial conditons in the soil are modified and the forcing
is perturbed. The response of the land surface scheme is expected to be
significantly different from the {\tt REF} integration.
\item {\it Assimilation runs} where observations are taken from the {\tt REF} run
whereas the initial conditions and the perturbed forcing correspond to the
{\tt OL} run. If the SLDAS works as expected it should progressively 
reach a state close to the {\tt REF} run. 
\end{itemize}
\vspace{0.5cm}
For the experiments proposed in this package,
the atmospheric forcing has been generated over a two-month period
in July-August 2002 over Central US (adapted from ERA40). The surface
specifications (soil/vegetation) are given in Mahfouf (2007). 
\section{Practical aspects}
The main directory is {\tt LDAS\_ISBA} that contains six
sub-directories :
\begin{itemize}
\item {\tt data\_in}: contains the input data for the atmospheric
forcing (already available for you) and the simulated observations (to be 
generated by you as explained in section 4).
\item {\tt data\_out}: contains the ouput files produced by the various
runs
\item {\tt proc}: contains the scripts to run the ISBA scheme and the
assimilation experiments. It also contains scripts to generate
graphics with the GNUPLOT software (check that it is
available on your PC by typing the command :{\tt gnuplot}). 
It contains a {\tt namelist} to define the most
important features of each run.
\item {\tt src1}: contains the sources, the executables and a {\tt Makefile}.
Experiments to be run from this directory correspond to screen-level observations
over a 6 hour assimilation window (similar to operational configurations)
\item {\tt src2}: contains the sources, the executables and a {\tt Makefile}.
Experiments to be run from this directory correspond to assimilations of both
screen-level observations and L-band brightness temperatures with
temporal frequencies of 6-h and 3 days respectively.
\item{\tt graphs}: contains postscript files generated by GNUPLOT.
\end{itemize}
\section{Practical aspects}
\subsection{How to generate the executable ?}
In the {\tt src1} and {\tt src2} directories, edit the 
{\tt Makefile} and change the compilation options if needed. Then, type the command
{\tt make}. It will generate an executable {\tt main-ref} that allows to run the various
experiments suggested in the practical exercises.
\subsection{How to launch the model and assimilation runs ?}
\subsubsection{Set-up the namelist for the reference run}
Edit the file {\tt proc/namelist}. 
\paragraph{\tt \&ASSIM}: In this block, set the following
logicals to  {\tt .FALSE.} to indicate that at this stage you don't want to perform
a data assimilation experiment : 
\begin{description}
\item   {\tt L\_OI = .FALSE.}
\item   {\tt L\_EC = .FALSE.}
\item   {\tt L\_2DVAR = .FALSE.}
\item   {\tt L\_EKF = .FALSE.}
\item   {\tt L\_ENKF = .FALSE.}
\end{description}
The other logicals in this block
are not used.
\paragraph{\tt \&SOILINIT}: In this block, define the initial soil conditions 
of the reference run for the two water reservoirs {\tt SWI1} ($w_g$)
and {\tt SWI2} ($w_2$)\footnote{defined in terms of {\it soil wetness index} 
$SWI=(w-w_{wilt})/(w_{fc}-w_{wilt})$ that is the "equivalent"
of relative humidity in the atmosphere, expect that negative
values and values above one can exist.} and the two
soil temperatures {\tt TG1} ($T_s$) and {\tt TG2} ($T_2$). 
These are the four elements of the
control variable $\mathbf{x}$. We suggest a value of 4 for the 
soil reservoirs (high value to produce saturated soils)
and of 295 K for the soil temperatures (see Mahfouf, 2007):
\begin{description}
 \item   {\tt SWI1 = 4.0}
 \item   {\tt SWI2 = 4.0}
 \item   {\tt TG1 = 295.}
 \item   {\tt TG2 = 295.}
\end{description}
\paragraph{\tt \&PERTRAIN} : In this block set the value of {\tt SCALE\_RAIN} to one (it means
that the precipitation forcing is not modified).
\subsubsection{Perform a reference run:}
Under the sub-directory {\tt proc}, type the following command to create the reference simulation :
\\
\\
{\tt submit.bat REF 2c}
\\
\\
The experiment type is {\tt REF} and the
experiment identifier {\tt 2c} (imposed for the {\tt REF} and {\tt OL} experiments
for reasons explained in the footnote
\footnote{We force the user 
to give {\tt 2c} for {\tt REF} and {\tt OL} experiments in {\tt src1} and {\tt 2f} for
{\tt REF} and {\tt OL} experiments in {\tt src2}, to avoid code modifications for the simulated observation
file name as well as in plotting script.}). For all assimilation experiments
there is no constraint on what the experiment identifier should be (it could be useful to have a log
file that makes the correspondence with the experimental set-up) 
\subsubsection{Perform an open loop run:} This run has the same namelist options
as the reference run except for different initial soil moisture conditions and a
modified precipitation forcing. We suggest the following values in the {\tt namelist} file:
{\tt SWI1 = 0}, {\tt SWI2 = 0}
and {\tt SCALE\_RAIN = 0.5}. The soil moisture content is at the wilting point (dry soils)
and the precipitation forcing is reduced by a factor of two. Then, type the following command: 
\\
\\
{\tt submit.bat OL 2c}
\subsubsection{Do it again !}The above steps allows to perform the reference and open loop runs that will
be used for the
assimilation of screen-level observations every 6 hours (in the {\tt src1} sub-directory).
For the same runs corresponding to the assimilation of L-band brightness temperature experiments
and screen-level parameters (in the {\tt src2} sub-directory), you should modify the {\tt namelist} file as
suggested before but type the following execution commands:
\\
\\
{\tt submit.bat REF 2f TB}
\\
\\
{\tt submit.bat OL 2f TB}
\\
\\
The additional key {\tt TB} allows to select the executable file in the {\tt src2} sub-directory.
\par
\vspace{0.5cm}
These two types of simulations are basically done once and they are used
to compare the behaviour of the various assimilations that you will run.
\subsection{What are the various assimilations that can be run ?}
\subsubsection{Assimilation of screen-level observations - directory {\tt src1}}
The possible choicees are given in the {\tt \&ASSIM} block of the {\tt namelist}.
When observations are screen-level temperature and relative humidty
and a 6-hour assimilation cycle (using executable in {\tt src1}).
As before, you have to modify the {\tt namelist} file in order to define the
various set-ups of for each experiment (given below). Then you have to type the
following command :
\\
\\
{\tt submit.bat exptype expid}
\\
\\
The {\tt exptype} is given below (not an user option) whereas the {\tt expid}
can be chosen at your convenience.
\begin{description}
\item {\sc Optimal interpolation using M\'et\'eo-France formulation} (Giard and Bazile, 2000):
{\tt L\_OI = .TRUE.} and all other logical set to {\tt .FALSE.}
\\
The {\tt exptype} is {\tt OI\_MF}
\item {\sc Optimal interpolation using ECMWF formulation} (Douville et al., 2000):
{\tt L\_OI = .TRUE.} and {\tt L\_EC = .TRUE.} with all other logical set to {\tt .FALSE.}
\\
The {\tt exptype} is {\tt OI\_EC}
\item {\sc Simplified 2D variational assimilation} (Balsamo et al. 2004):
{\tt L\_2DVAR = .TRUE.} and all the other logical are set to  {\tt .FALSE.}
\\
The {\tt exptype} is {\tt 2DVAR}
\item {\sc Simplified Extended Kalman filter} (Seuffert et al., 2004)
{\tt L\_EKF = .TRUE.} and all the other logical are set to  {\tt .FALSE.}. The
simplication lies in the fact that the $\mathbf{B}$ matrix remains constant
at each cycle. 
\\
The {\tt exptype} is {\tt  EKF}
\item {\sc Ensemble Kalman filter} (Lorenc, 2003; Evensen, 2002):
{\tt L\_ENKF = .TRUE.}. All other logical are set to {\tt .FALSE.}
except the value {\tt L\_NOISE} that can be set to {\tt .TRUE.} in order
to include noise in the atmospheric forcing (but not recommended as
the default, since results are not particularly good).
\\
The {\tt exptype} is {\tt ENKF}
\end{description}
\subsubsection{Assimilation of L-band brightness temperatures and screen-level 
observations - directory {\tt src2}}
When observations are 2m temperature and humidity
as well as L-band brightness temperatures (using executables in {\tt src2}),
two additional logicals have to be defined. They indicate which type of observations has to 
be considered : {\tt L\_WG = .TRUE.} for the assimilation of brightness temperatures
(every 3 days)
and {\tt L\_2M = .TRUE.} for the 
assimilation of screen-level observations (every 6 hours).
As before you have to modify the {\tt namelist} file in order to define the
various set-ups of each experiment (given below). Then, you have to type the
following command :
\\
\\
{\tt submit.bat exptype expid  TB}
\\
\\
The {\tt exptype} is given below (not an user option) whereas the {\tt expid}
has to chosen at your convenience.
\begin{description}
\item {\sc Simplified 2D variational assimilation} (Balsamo et al. 2004):
{\tt L\_2DVAR = .TRUE.} the other logical are set to  {\tt .FALSE.}.
The Jacobian of the observation operator is evolved over a 3-day period
to allow the assimilation to produce analyses every 6 hours instead of every 3 days
(see Mahfouf (2007) for details). \\
The {\tt exptype} is {\tt 2DVAR}
\item {\sc Extended Kalman filter} (Seuffert et al., 2004)
{\tt L\_EKF = .TRUE.} and the other logical are set to  {\tt .FALSE.}. The
the $\mathbf{B}$ matrix evolves according the Kalman filter equations but
is set back to the diagonal matrix every 3-days (to account for the
fact that the specification of the $\mathbf{Q}$ matrix is rather arbitrary).  
\\
The {\tt exptype} is {\tt  EKF}
\item {\sc Ensemble Kalman filter} (Lorenc, 2003; Evensen, 2002):
{\tt L\_ENKF = .TRUE.}. All other logical are set to {\tt .FALSE.}
except {\tt L\_NOISE} that can be set to {\tt .TRUE.} in order
to include noise in the atmospheric forcing (but not recommended as
the default, since results are not particularly good).
\\
The {\tt exptype} is {\tt ENKF}
\end{description}
\section{Tunable parameters of the assimilations}
All these parameters have to be defined in the {\tt namelist}
\begin{description}
\item {\tt \&OBSERR} : The observation errors (standard deviations defining the
 $\mathbf{R}$ matrix) for each element of the observation vector $\mathbf{y}_o$
\item {\tt \&SIZEJAC} : The size of the perturbation of the control vector to get the Jacobians
in finite differences 
\item {\tt \&BKGERR} : The background errors (standard deviations defining a
diagonal $\mathbf{B}$ matrix) for each element of the control vector
$\mathbf{x}$  
\item {\tt \&BKGERR} : The model errors (standard deviations defining
a diagonal $\mathbf{Q}$ matrix) for each element of the control
vector $\mathbf{x}$ (same units as $\mathbf{B}$). This specification
is only required for the EKF option.
\item {\tt \&SETENKF}: The ensemble size {\tt NDIM} and the inflation factor {\tt XINFL}
(every 6 hours) for the Ensemble Kalman filter (ENKF)
\end{description}
\section{Graphics}
By typing the command:
\\
\\
{\tt proc/plot\_model\_variables.bat exptype expid}
\\
\\
a postscript figure is generated :
\\
\\
{\tt graphs/FIGURE\_exptypeexpid.ps}
\\
\\
In the case of the ENKF the spread of the ensemble (diagonal elements of $\mathbf{B}$)
can be plotted by the command:
\\
\\
{\tt proc/plot\_enkf.bat exptype expid}
\\
\\
The following postcript file is generated:
\\
\\
{\tt graphs/FC\_ERRORS\_ENKF\_expid.ps}
\\
\\
You should be able to recover most of the figures presented in Mahfouf (2007) and 
examine the main features of each assimilation system.
\section{The subroutines}
\subsection{ISBA}
The ISBA scheme is considered as a black box that evolves (over a specified time window)
the model state $\mathbf{x}$ from an
initial state {\tt XI} to a final state {\tt XF}, and produces the simulated observations
$\mathbf{y}$ ({\tt YF}). 
\vspace{0.5cm}
\begin{itemize}
\item {\tt isba.f90} : main driver of the ISBA scheme that performs initialisations (except the
atmospheric forcing), runs the scheme and post-process the ouputs. 
The projection of the model state in the observation space
is done in this subroutine (i.e. that defines the observation operators).
\item {\tt drag\_coeff\_z0h.f90}: computation of the surface aerodynamic resistance using
Louis et al. (1982) formulation (stability function depending on the Richarsdon number), and
generalized by Mascart et al. (1995) to the situation of different roughness lengths for heat
and momentum.
\item {\tt energy\_budget.f90}: resolution of the prognostic equations for $T_s$ and $T_2$
(implicit resolution for $T_s$ by a linearization of the various terms of the
surface energy balance).
\item {\tt fluxes.f90}: diagnostic of the fluxes entering the surface energy balance
\item {\tt init\_surf.f90}: definition of the initial conditions characterizing the soil
and the vegetation (except for the soil texture that is defined in {\tt isba.f90}).
\item {\tt interpol\_forcing.f90}: temporal interpolation of the forcing including
an option for noise generation in the EnKF 
\item {\tt rs\_soil.f90}: computation of the soil resistance for bare soil evaporation
(ECMWF formulation)
\item {\tt rs\_veg.f90}: computation of the canopy resistance (important dependency with $w_2$)
\item {\tt soil\_prop.f90}: computation of the thermal and hydraulic coefficients of
the force-restore scheme (see Appendix A of Noilhan and Mahfouf, 1996) ($C_1$, $C_2$, $C_G$ and $w_{geq}$).
\item {\tt soil\_def.f90}: computation of the soil constants depending on soil texture only
\item {\tt water\_budget.f90}: resolution of the prognostic equations for $w_g$ and $w_2$
A red noise is added in the equations (parameters defined in this routine) when the EnKF is used (to
describe model errors as proposed by Evensen (2002)).
\end{itemize}
\subsection{Inputs/ouputs}
\begin{itemize}
\item {\tt read\_forcing.f90} : reads the forcing data set (the file name to be read is
explicitely given in this routine)
\item {\tt print\_output\_enkf.f90} : computation of means and standard deviations from the EnKF
outputs for comparison with deterministic assimilations
\item {\tt print\_output\_oi.f90}: computation of accumulated fluxes and store the various
diagnostic and prognostic variables produced by ISBA in files (see Section 8 for file naming
and content)
\item {\tt clean\_exit.f90} : deallocation of arrays
\end{itemize}
\subsection{Analyses}
\begin{itemize}
\item {\tt master.f90} : main driver program that selects the proper simulation
according the logicals defined in {\tt \&ASSIM} of the {\tt namelist}. Does nothing
if inconsistencies are identified.
\item {\tt main.f90} :  driver to produce the reference ({\tt REF}) and open loop ({\tt OL}) runs of ISBA
\item {\tt main\_oi.f90}: driver to produce analyses from optimum interpolations, simplified
2D-Var, and Extended Kalman Filter
\item {\tt main\_enkf.f90}: driver to produce analyses from the Ensemble Kalman filter
\item {\tt oi\_coeffs\_ec.f90}: computation of the optimum interpolation coefficients to
analyse soil variables from $T_{2m}$ and $HU_{2m}$ using the ECMWF formulation (Douville et al., 2000).
\item {\tt oi\_coeffs\_mf.f90}: computation of the optimum interpolation coefficients to
analyse soil variables from $T_{2m}$ and $HU_{2m}$ using the M\'et\'eo-France formulation (Giard and Bazile, 2000).
\end{itemize}
\subsection{Tools : algebra and others}
\begin{description}
\item {\tt chlodc.f90} : Cholesky factorization (part I) for inversion of a symmetric matrix
\item {\tt chlosl.f90} : Cholesky factorization (part II) for inversion of a symmetric matrix
\item {\tt inverse\_matrix.f90}: produce the inverse matrix that has been implicitly obtained
in the Cholesky decomposition.
\item {\tt gasdev.f90}:  Generation of a random number following a Gaussian distribution of zero mean and 
variance one.
\item {\tt out\_product.f90}: Get a matrix $\mathbf{xy}^T$ formed
by the outer product of two vectors $\mathbf{x}$ and $\mathbf{y}$ (used in the EnKF approach) 
\item {\tt solar\_angle.f90}: Computation of the solar zenith angle knowing the location in space
and time of a given point.
\item {\tt thermo\_functions.f90}: Computation of the saturation water vapour pressure, specific
humidity at saturation and their derivatives with respect to temperature.
\end{description}
\subsection{Observation operators}
\begin{itemize}
\item {\tt lsmem.f90}: simple microwave radiative transfer model to simulate L-band
brightness temperatures from the superficial moisture content.
\item {\tt cls\_interpol.f90}: vertical interpolation at observation level (2m and 10m) using
Monin-Obukhov similarity theory and Businger-Dyer stability functions.
\item {\tt vdfppcfls.f90}: vertical interpolation at observation level (2m and 10m) using
Monin-Obukhov similarity theory and Geleyn (1988) formulation.
\end{itemize}
\section{The main output files}
In the directory {\tt data\_out} the following files are created for each assimilation run:
\begin{description}
\item {\tt FIC22\_exptypeexpid.dat} (simulated observations) : $day$ , $T_{2m}$ , $HU_{2m}$ 
\item {\tt FIC23\_exptypeexpid.dat} (prognostic variables) : $day$ , $T_s$ , $T_2$ , $w_g$ , $w_2$
\item {\tt FIC24\_exptypeexpid.dat} (instantaneous surface energy fluxes) : $day$ , $R_n$ , $H$ , $LE$, $G$
\item {\tt FIC25\_exptypeexpid.dat} (accumulated water fluxes) : $day$ , $\Sigma LE$, $\Sigma Precip $ , $\Sigma Runoff$
\item {\tt FIC26\_exptypeexpid.dat} (accumulated energy fluxes) : $day$ , $\Sigma R_n$, $\Sigma LE $ , $\Sigma H$ , $\Sigma G$
\item {\tt FIC27\_exptypeexpid.dat} (standard-deviations from the ensemble mean : EnKF only) : $day$ , $\sigma_{wg}$, $\sigma_{w2}$ , $\sigma_{Ts}$ ,
$\sigma_{T2}$ , $\sigma_{LE}$ , $\sigma_{H}$ 
\item {\tt FIC55\_exptypeexpid.dat} (Jacobians of observation operator) : $day$ , $\partial T_{2m} / \partial w_g$ , $\partial T_{2m} / \partial w_2$,
$\partial T_{2m} / \partial T_s$ , $\partial T_{2m} / \partial T_2$ 
\item {\tt FIC56\_exptypeexpid.dat} (Jacobians of observation operator) : $day$ , $\partial HU_{2m} / \partial w_g$ , $\partial HU_{2m} / \partial w_2$,
$\partial HU_{2m} / \partial T_s$ , $\partial HU_{2m} / \partial T_2$
\end{description}
\section{The ISBA land surface scheme}
The ISBA scheme evolves four prognostic variables:
\begin{eqnarray}
\pd{T_s}{t} &=& C_T(R_n-H-LE) - \frac{2\pi}{\tau}(T_s-T_2)
\\
\pd{T_2}{t} &=& \frac{1}{\tau} (T_s - T_2)
\\
\pd{w_g}{t} &=& \frac{C_1}{\rho_w d_1}(P_g - E_g) - \frac{C_2}{\tau}(w_g - w_{geq})
\\
\pd{w_2}{t} &=& \frac{1}{\rho_w d_1}(P_g - E_g - E_{tr}) - \frac{C_3}{\tau}
\max\left[0.,(w_2 - w_{fc})\right]
\end{eqnarray}
\section{The main analysis equations}
\subsection{The Extended Kalman filter ({\tt EKF})}
We consider a control vector $\mathbf{x}$ (dimension $N_x$)
that represents the prognostic equations of the land surface scheme ISBA  $\mathcal{M}$ 
({\tt isba.f90}) that
evolves with time as:
\[
\mathbf{x}^t = \mathcal{M}(\mathbf{x}^{0})
\]
Therefore $N_x=4$ and $\mathbf{x}=(w_g,w_2,T_s,T_2)$
\\
At a given time $t$ a vector of observation is available $\mathbf{y}_o$
(with a dimension $N_y$) characterized by an error covariance matrix
$\mathbf{R}$. An observation operator $\mathcal{H}$
allows to get the model counterpart of the observations :
\[
\mathbf{y}^t = \mathcal{H}(\mathbf{x}^t)
\]
In our case, $\mathcal{H}$ will be a vertical interpolation scheme for $T_{2m}$
and $HU_{2m}$ ({\tt vdfppcfls.f90}) and microwave radiative transfer model
for brightness temperatures (2 polarizations) $T_{bV}$ and $T_{bH}$ 
({\tt lsmem.f90}). The dimension of the observation vector is $N_y=4$.
The forecast $\mathbf{x}$ at time $t$ (written $\mathbf{x_f}^t$)
is characterized by an background error covariance matrix
$\mathbf{B}$. 
The implicit hypotheses for the errors is that they are gaussian and unbiased.
\par
A new value of $\mathbf{x}$ written $\mathbf{x_a}^t$
(the analysis), obtained by an optimal combination the
observations and the background (short-range forecast), is given by :
\[
\mathbf{x_a}^t = \mathbf{x_f}^t + \mathbf{B}\mathbf{H}^T(
 \mathbf{HBH}^T +  \mathbf{R})^{-1} (\mathbf{y}^t_o -
 \mathcal{H}(\mathbf{x_f}^t))
\]
Since the observation operator can be non-linear, a new
operator appears in this analysis equation : $\mathbf{H}$ (together
with its transpose $\mathbf{H}^T$).
It corresponds to the Jacobian matrix of $\mathcal{H}$
defined as :
\[
\mathbf{H}_{ij} = \frac{\partial \mathbf{y}_j}{\partial \mathbf{x}_i}
\]
This matrix has $N_x$ raws and  $N_y$ columns.
In SLDAS  we use a finite difference approach 
where the input vector $\mathbf{x}$ is perturbed $N_x$ times
to get for each integration a column of the matrix $\mathbf{H}$, that is :
\[
\mathbf{H}_{ij} \simeq \frac{\mathbf{y}_i(\mathbf{x}+\delta  {x}_j)-\mathbf{y}_i(\mathbf{x})}{{\delta x}_j}
\]
where $\delta x_j$ is a small increment value added to the $j$-th component of the
$\mathbf{x}$ vector (defined in the block {\tt \&SIZEJAC} of the {\tt namelist}
file by the values {\tt EPS\_W1} (for $w_g$), {\tt EPS\_W2} (for $w_2$),
{\tt EPS\_T1} (for $T_s$), {\tt EPS\_T2} (for $T_2$)).
This is an interesting alternative to the adjoint coding when the size
of the control vector is not too large.
\\
The analysis state in characterized by an analysis error covariance matrix:
\[
\mathbf{A} = (\mathbf{I} - \mathbf{KH})\mathbf{B}
\]
where  $\mathbf{K}$ is the gain matrix defined in the analysis equation by:
\[
\mathbf{K} = \mathbf{B}\mathbf{H}^T(
 \mathbf{HBH}^T +  \mathbf{R})^{-1} 
\]
it relates linearly the {\it analysis increments}
\[
[\mathbf{x_a} - \mathbf{x_f}]
\]
to the  {\it innovation vector} :
\[  
[\mathbf{y}_o - \mathcal{H}(\mathbf{x_f})]
\]
The analysis is cycled by propagating the time the two quantities
$\mathbf{x_a}$ et $\mathbf{A}$
up to next time where observations are available :
\[
\mathbf{x_f}^{t+1} = \mathcal{M}(\mathbf{x_a}^t)
\]
\[
\mathbf{B}^{t+1} = \mathbf{MA}^t\mathbf{M}^T + \mathbf{Q}
\]
This equation requires the Jacobian matrix $\mathbf{M}$ of the model $\mathcal{M}$,
that is defined as (between time $t$ and time $t_0$):
\[
\mathbf{M}_{ij}= \pd{x_i^t}{x_j^0}
\]
A new matrix $\mathbf{Q}$ representing the model error covariance
matrix needs to be defined. 
This sequential approach is the {\it Extended Kalman filter}
as coded in the {\tt src2} directory.
\subsection{Variational assimilation}
It is possible to show that when $\mathcal{H}$ is linear,
the EKF solution is identical to the one provided by a variational
approach where a state $\mathbf{x}$ minimizes a cost-function
measuring the departure between a bacground information (short-range forecast)
$\mathbf{x_b}$ and available observations $\mathbf{y}_o$:
\[
J(\mathbf{x}) = \frac{1}{2}(\mathbf{x} - \mathbf{x_b})^T \mathbf{B}^{-1}
 (\mathbf{x} - \mathbf{x_b}) +
\frac{1}{2} 
(\mathbf{y}_o -  \mathcal{H}(\mathbf{x}))^T  \mathbf{R}^{-1}
(\mathbf{y}_o -  \mathcal{H}(\mathbf{x}))
\]
The minimum of $J$ is found by computing its gradient that is
given to a descent algorithm :
 \[
\nabla J(\mathbf{x}) =  \mathbf{B}^{-1}
 (\mathbf{x} - \mathbf{x_b}) +
\mathbf{H}^T\mathbf{R}^{-1}
(\mathbf{y}_o -  \mathcal{H}(\mathbf{x}))
\]
where appears 
the transpose (adjoint) of the observator operator $\mathbf{H}^T$ 
\par 
The above cost function does not include the time dimension explicitely.
It can be applied at a given time like a Kalman filter (3D-Var),
but also over a temporal interval : a state $\mathbf{x}^0$
at the beginning of the assimilation window is searched so that it leads to
a model state $\mathbf{x}^t$ fitting all the available
observations at several times over the period (4D-Var).
In that case, the observation operator is the combination of
a first operator (forecast model) evolving the initial state $\mathbf{x}^0$
up to a time $t$ where a vector of observations is available $\mathbf{y}_o^t$ :
\[
\mathbf{x}^t = \mathcal{M}(\mathbf{x}^0)
\]
and a "true" observation operator (as defined in the EKF)
that gives the model equivalent of the observation at the same time :
\[
\mathbf{y}^t =  \mathcal{H}(\mathbf{x}^t)
\]
Finally, the relation between the variable to be analyzed and the available
observation is :
\[
\mathbf{y}^t =  \mathcal{H}_1  (\mathbf{x}^0)
\]
with $\mathcal{H }_1= \mathcal{H}\mathcal{M}$.
This approach allows modification of the $\mathbf{B}$ matrix over the
assimilation window by the linearized versions of the
forecast model: at a given time $t$, the effective $\mathbf{B}$
matrix is $\mathbf{MBM}^T$ (which is similar to
the propagation of the $\mathbf{A}$ matrix in the Kalman filter
without the error model term and without explicit matrix evolution).

The variational method is rather expensive since the linearized
operator
 $\mathbf{H}_1$ is needed at each iteration of a minimization
algorithm.
\subsection{Simplified variational assimilation ({\tt 2DVAR})}
The cost of the variational assimilation can be significantly reduced
(i.e. no minimization), if
the observation operator can be linearized as:
\[
\mathcal{H} (\mathbf{x}^t) = \mathcal{H} \left[
\mathcal{M}(\mathbf{x_b}^0) \right] +
\mathbf{HM} ( \mathbf{x}^0 - \mathbf{x_b}^0)
\]
The analysis state at the beginning of the assimilation window can be written as:
\[
\mathbf{x_a}^0 = \mathbf{x_f}^0 + \mathbf{B}\mathbf{H}^T
\mathbf{M}^T(
 \mathbf{HMBM}^T\mathbf{H}^T +  \mathbf{R})^{-1} (\mathbf{y}^t_o -
 \mathcal{H}\left[\mathcal{M}(\mathbf{x_f}^0)\right])
\]
This state in then progated by the model $\mathcal{M}$
to define the initial state of the next cycle.  
In the case of a linear model this equation is
equivalent to an Extended Kalman Filter but 
where the model error term $\mathbf{Q}$ is set to zero
(perfect model assumption).
This approach is cheaper than a real variational assimilation
and takes into account simultaneous observations at various times
(implicit evolution of the $\mathbf{B}$ matrix over the assimilation
window).  The length of the window depends upon the linearity
of the combined operator : $\mathcal{H}\mathcal{M}$. 
In a EKF (or EnKF) approach the time window of the assimilation
corresponds to the interval between the most
frequent observations.
\subsection{The ensemble Kalman filter ({\tt ENKF})}
This approach has been developed widely during the last ten years
as it allows to by-pass the problem of the linearized observation
operators (Jacobians)
 $\mathbf{H}$, $\mathbf{M}$, $\mathbf{H}^T$, and
$\mathbf{M}^T$ 
as well as the specification of the 
$\mathbf{B}$ matrix. It is rather popular in hydrology (Crow and Wood, 2003; Reichle et al., 2002).
The same equation as for the EKF is solved, but the matrices
  $\mathbf{BH}^T$ and 
$\mathbf{HBH}^T$  are  obtained from an ensemble of predictions
$(\mathbf{x_f})_i$ with $i$ varying between 1 et $N$. The value of $N$
has been chosen to 100 in LSDAS ({\tt NDIM}). One writes :
\[
\mathbf{BH}^T  \approx 
\overline{(\mathbf{x_f}-\overline{\mathbf{x_f}})
(\mathcal{H}(\mathbf{x_f}) - \overline{\mathcal{H}(\mathbf{x_f}}))^T}
\]
\[
\mathbf{HBH}^T  \approx 
\overline{(\mathcal{H}(\mathbf{x_f})-\overline{\mathcal{H}(\mathbf{x_f}}))
(\mathcal{H}(\mathbf{x_f}) - \overline{\mathcal{H}(\mathbf{x_f}}))^T}
\]
with the average operators : 
\[
\overline{\mathbf{x}}= \frac{1}{N}\sum_{i=1}^N \mathbf{x}_i
\]
\[
\overline{\mathbf{x}\mathbf{y}^T}= \frac{1}{N-1} \sum_{i=1}^N
\mathbf{x}_i
\mathbf{y}^T_i
\]
An advantage of this approach is that there is no need to get explicitly
the various matrices entering in the computation of the Kalman gain 
$\mathbf{K}$. 
The spread of the ensemble is obtained by perturbing randomly the observations
according to the $\mathbf{R}$ matrix. Small values of $N$ for sampling the
error statistics lead to an underestimation of the analysis error
covariance matrix, that leads to a divergence of the filter (the background
is becoming more and more accurate and observations are becoming useless).
To remedy this problem, the spread of the ensemble can be artificially enhanced
at each analysis cycle (inflation factor) and by introducing model errors in
the prognostic equations (that are however rather difficult to tune).
\par
In practice, each analysis $\mathbf{x}_a^i$  is given by the filter from
the following equation:
\[
\mathbf{x}_a^{i} = \mathbf{x}_b^{i} + \mathbf{K}[
\mathbf{y}_0 - \mathcal{H}(\mathbf{x}_b^i) + \varepsilon_i] 
\]
where $\varepsilon$ is a random noise with gaussian distribution having a zero mean
and a variance given by $\mathbf{R}$. The gain matrix is computed using
the approximated values of $\mathbf{BH}^T$ and $\mathbf{HBH}^T$ given by the above equations.
The prognostic variables for soil water contents $w$ have been modified to
add a model error term $\varphi$ defined by :
\[
\varphi^{t+1}= \nu \varphi^{t} + \varepsilon_w\sqrt{1-\nu^2}
\]
\[
w^{t+1} = \mathcal{F}(w^{t}) + \varphi^{t+1} \Delta t
\]
with $\nu=1/(1+\Delta t/\tau)$. 
It is a first order autoregressive model with temporal correlation $\tau$ of 3 days
and  a gaussian noise amplitude $\varepsilon_w$
set to  \`a 0.001 m$^3$/m$^3$/day. These quantities are hardcoded in the
subroutine {\tt water\_budget.f90} and could be modified for sensitivity studies.
\par
In order to avoid an underestimation of the analysis error covariance matrix $\mathbf{A}$,
after each analysis cycle an inflation factor $\alpha$ ({\tt XINFL} in {\tt namelist})
leads to a redefinition of the various analysed members as:
\[
\mathbf{x}_a = \overline{\mathbf{x}_a} + \alpha(\mathbf{x}_a - \overline{\mathbf{x}_a})
\]
In practice a value of $1.015$ has been chosen for a 6 hour cycling.
\section{Namelist default values}
$~$\\
 {\tt \&ASSIM {\rm [options for experiment type]} \\
   L\_OI = .FALSE.\\
   L\_EC = .FALSE.\\
   L\_2DVAR = .FALSE.\\
   L\_EKF = .FALSE.\\
   L\_ENKF = .FALSE.\\
   L\_NOISE = .FALSE.[\rm option to add noise in the forcing - works only with ENKF]\\
   L\_WG = .TRUE.[\rm option when assimilation of combined obs types]\\
   L\_2M = .TRUE.[\rm option when assimilation of combined obs types]\\
 /\\
 \&SETENKF {\rm [options for ensemble kalman filter]}\\
   NDIM = 100 {\rm [ensemble size $N$]\\
   XINFL = 1.015 {\rm [inflation factor $\alpha$]\\
 /\\
 \&SOILINIT {\rm [options for initialisation of soil prognostic variables]}\\
   SWI1 = 4.0 [\rm soil wetness index for $w_g$]\\
   SWI2 = 4.0 [\rm soil wetness index for $w_2$]\\
   TG1 = 295. [\rm surface temperature $T_s$]\\
   TG2 = 295. [\rm deep temperature $T_2$]\\
 /\\
 \&PERTRAIN {\rm [option for rescaling the precipitation forcing]}\\
   SCALE\_RAIN = 1.0\\
 /\\
 \&SIZEJAC {\rm [option to define the perturbation size for the Jacobian estimation]\\
   EPS\_W1 = 0.0001 [\rm perturbation for $w_g$ in soil wetness index (SWI)]\\
   EPS\_W2 = 0.0001 [\rm perturbation for $w_2$ in soil wetness index (SWI)]\\
   EPS\_T1 = 0.001  [\rm perturbation for $T_s$ in K] \\
   EPS\_T2 = 0.001  [\rm perturbation for $T_2$ in K]\\
 /\\
 \&OBSERR {\rm [option to define the observation errors]}\\
   ER\_T2M = 1.0 [\rm standard deviation error for 2-m temperature ($\sigma_{T2m}$) in K]\\
   ER\_HU2M = 0.1 [\rm standard deviation error for 2-m relative humidity ($\sigma_{HU2m}$) no units]\\
   ER\_TB = 2.0 [\rm standard deviation error for L-band brightness temperature ($\sigma_{Tb}$) in K]\\
   ER\_WG = 0.1 [\rm standard deviation error for surface soil moisture ($\sigma_{w_g}$) in SWI (not used)]\\
 /\\
 \&BKGERR {\rm [option to define the background errors]}\\
   ER\_W1 = 0.1 [\rm standard deviation error for surface soil moisture ($\sigma_{w_g}$) in SWI]\\ 
   ER\_W2 = 0.1 [\rm standard deviation error for deep soil moisture ($\sigma_{w_2}$) in SWI]\\  
   ER\_T1 = 1.0 [\rm standard deviation error for surface temperature ($\sigma_{T_s}$) in K]\\ 
   ER\_T2 = 1.0 [\rm standard deviation error for deep soil temperature ($\sigma_{T_s}$) in K]\\ 
 /\\
 \&MODERR {\rm [option to define the model errors]}\\
   Q\_W1 = 0.02 [\rm standard deviation error for surface soil moisture ($\sigma_{w_g}$) in SWI]\\
   Q\_W2 = 0.02 [\rm standard deviation error for deep soil moisture ($\sigma_{w_2}$) in SWI]\\
   Q\_T1 = 0.5 [\rm standard deviation error for surface temperature ($\sigma_{T_s}$) in K]\\
   Q\_T2 = 0.5 [\rm standard deviation error for deep soil temperature ($\sigma_{T_s}$) in K]\\
 /}
\section{Summary of experimental set-ups}
\begin{table}[h]
\bc
\begin{tabular}{|c|c|c|c|c|c|c|}
\hline
Experiment & {\tt exptype} & {\tt L\_OI} & {\tt L\_EC} & {\tt L\_EKF} & {\tt L\_2DVAR} & {\tt L\_ENKF} \\
\hline
Reference run & {\tt REF} & F & F & F & F & F \\
\hline
Open loop run & {\tt OL} & F & F & F & F & F \\
\hline
OI M\'et\'eo-France & {\tt OI\_MF} & \bf{T} & F & F & F & F \\
\hline
OI ECMWF & {\tt OI\_EC} & \bf{T} & \bf{T} & F & F & F \\
\hline
Extended Kalman filter & {\tt EKF}  & F & F & \bf{T} & F & F \\
\hline
Simplified 2D-Var & {\tt 2DVAR} & F & F & F & \bf{T} & F \\
\hline
Ensemble Kalman filter & {\tt ENKF} & F & F & F & F & \bf{T} \\
\hline
\end{tabular}
\caption{Summary of possible experiments}
\ec
\end{table}
%\section{Exercises}
\newpage
\section{References}
\begin{description}
\item Balsamo, G., F. Bouyssel, and. J. Noilhan, 2004:
A simplified bi-dimensional variational analysis of soil moisture from
screen-level observations in a mesoscale numerical weather prediction model.
{\it Quart. J. Roy. Meteor. Soc.}, {\bf 130}, 895-915.
\url{https://doi.org/10.1256/qj.02.215}


%\item Balsamo, G., {J.-F. Mahfouf}, { S. B\'elair}, and G. Deblonde, 2006: A global root-zone soil moisture %analysis using simulated L-band brightness temperature in preparation for the HYDROS satellite mission. 
%{\it J. Hydrometeor.}, {\bf 7}, 1126-1146.

\item Balsamo, G., J.-F. Mahfouf, S. B\'elair, and G. Deblonde, 2007:
A land data assimilation system for soil moisture and temperature : an
information content study. {\it J. Hydrometeor.}, {\bf 8}, 1225-1242.
\url{https://doi.org/10.1175/2007JHM819.1}

\item Bouttier, F., J.-F. Mahfouf, and J. Noilhan, 1993:
Sequential assimilation of soil moisture from atmospheric low-level parameters. Part I:
Sensitivity and calibration studies. {\it J. Appl. Meteor.}, {\bf 32}, 1335-1351.
\url{https://doi.org/10.1175/1520-0450(1993)032%3C1335:SAOSMF%3E2.0.CO;2}

%\item Calvet, J.-C., J. Noilhan, and P. Bessemoulin, 1998 : Retrieving
%the root-zone soil moisture from surface soil moisture or temperature estimates:
%a feasibility study based on field measurements. {\it J.  Appl. Meteor.}, {\bf 37},
%371-386.

%\item Calvet, J,-C., and J. Noilhan, 2000: From near-surface to root-zone soil
%moisture using year-round data. {\it J. Hydrometeor.}, {\bf 1}, 393-411.

\item Crow, W.T. and Wood, E.F., 2003: The assimilation of remotely sensed soil brightness temperature imagery into a land-surface model using ensemble Kalman filtering: a case study based on ESTAR measurements during SGP97. 
{\it Advances in Water Resources}, {\bf 26}, 137-149. \url{https://doi.org/10.1016/S0309-1708(02)00088-X} 

\item Douville, H., P. Viterbo, J.-F. Mahfouf, and A.C.M. Beljaars, 2000:
Evaluation of optimal interpolation and nudging techniques for soil moisture
analysis using FIFE data. {\it Mon. Wea. Rev.}, {\bf 128}, 1733-1756.
\url{https://doi.org/10.1175/1520-0493(2000)128\%3C1733:EOTOIA%3E2.0.CO;2}

\item Evensen, G., 2003 : The ensemble Kalman Filter: Theoretical formulation
and practical implementation. {\it Ocean Dyn.}, {\bf 53}, 343-367.
\url{https://doi.org/10.1007/s10236-003-0036-9}

\item Geleyn, J.-F., 1988: Interpolation of wind, temperature, humidity values
from model levels to the height of measurement. {\it Tellus}, {\bf 40A}, 347-351.
\url{https://doi.org/10.3402/tellusa.v40i4.11805}

\item Giard, D., and E. Bazile, 2000: Implementation of a new assimilation scheme
for soil and surface variables in a global NWP model. {\it Mon. Wea. Rev.},
{\bf 128}, 997-1015.
\url{https://doi.org/10.1175/1520-0493(2000)128\%3C0997:IOANAS\%3E2.0.CO;2}

\item Hess, R., 2001: Assimilation of screen-level observations by
  variational soil moisture analysis. {\it Meteor. Atmos. Phy.}, {\bf 77}, 145-154.
\url{https://doi.org/10.1007/s007030170023}

\item Houtekamer, P. and H.L. Mitchell, 1998: Data assimilation
using an Ensemble Kalman filter technique.
{\it Mon. Wea. Rev.}, {\bf 126}, 796-811.
\url{https://doi.org/10.1175/1520-0493(1998)126\%3C0796:DAUAEK\%3E2.0.CO;2}

\item Lorenc, A.C., 2003: The potential of the ensemble Kalman filter for NWP - a comparison with 4D-Var. {\it Quart.J. Roy. Meteor. Soc.}, {\bf 129}, 3183-3203. \url{https://doi.org/10.1256/qj.02.132}

\item Louis, J.-F., J.-F. Geleyn and M. Tiedtke, 1982: A short history of the PBL parameterization at ECMWF. Proceedings of the Workshop on Planetary Boundary Layer parameterization, 25-27 Nov. 1981, ECMWF, Reading (U.K.), 59-79.
\url{https://www.ecmwf.int/sites/default/files/elibrary/1982/75473-short-history-pbl-parameterization-ecmwf_0.pdf}

\item Mahfouf, J.-F., 1991: Analysis of soil moisture from
  near-surface parameters: A feasibility study.
{\it J. Appl. Meteor.}, {\bf 30}, 506-526.
\url{https://doi.org/10.1175/1520-0450(1991)030\%3C1534:AOSMFN\%3E2.0.CO;2}

\item Mahfouf, J.-F., and J. Noilhan, 1991:
Comparative study of various formulations of evaporation from bare soil
using in-situ data. {\it J. Appl. Meteor.}, {\bf 30}, 1354-1365.
\url{https://doi.org/10.1175/1520-0450(1991)030\%3C1354:CSOVFO\%3E2.0.CO;2}

%\item Mahfouf, J.-F., A.O. Manzi, J. Noilhan, H. Giordani, and M. D\'equ\'e, 1995:
%The land surface scheme ISBA within the M\'et\'eo-France climate model ARPEGE.
%Part I: Implementation and preliminary results.
%{\it J. Climate}, {\bf 8}, 2039-2057.

%\item Mahfouf, J.-F., H. Douville, P. Viterbo, A. Beljaars, and S. Saarinen, 2000:
%A revised land surface analysis scheme in the Integrated Forecasting System.
%{\it ECMWF Newsletter}, {\bf 88}, 8-13.

\item  Mahfouf, 2007: The M\'et\'eo-France soil analysis.
Part I: Evaluation and perspectives at local scale (in French).
Note de Centre CNRM/GMME No 84. 
\url{https://hal.science/hal-04390802}

\item Mascart, P., J. Noilhan, and H. Giordani, 1995:
A modified parameterization of the surface layer flux-profile
relationships using different roughness length values for
heat and momentum. {\it Bound. Layer. Meteor.}, {\bf 72}, 331-344.
\url{https://doi.org/10.1007/BF00708998}

\item Mu\~noz-Sabater, J., L. Jarlan, J.-C. Calvet, F. Bouyssel, and P. De Rosnay,
  2007:
From near-surface to root-zone soil moisture using different
assimilation techniques. 
{\it J. Hydrometeor.}, {\bf 8}, 194-206.
\url{https://doi.org/10.1175/JHM571.1}

\item Noilhan, J. , and J.-F. Mahfouf, 1996: The ISBA land surface parameterization
scheme. {\it Global Planet. Change}, {\bf 13}, 145-159.
\url{https://doi.org/10.1016/0921-8181(95)00043-7}

\item Press, W.H., S.A. Teukolsky, W.T. Vetterling, and B.P. Flannery, 1992:
Numerical recipes in FORTRAN. The art of scientific computing. Cambridge
University Press, 963 pp.
\url{http://s3.amazonaws.com/nrbook.com/book_F210.html}

\item Reichle, R. H., J. P. Walker, R. D. Koster, and P. R. Houser, 2002: Extended versus Ensemble Kalman Filtering for Land Data Assimilation. {\it J. Hydrometeor.}, {\bf 3}, 728-740. \url{https://doi.org/10.1175/1525-7541(2002)003<0728:EVEKFF>2.0.CO;2} 

\item Seuffert, G., H. Wilker, P. Viterbo, M. Drusch, and
  {J.-F. Mahfouf}, 2004:
The usage of screen-level parameters and 
microwave brightness temperature for soil moisture analysis.
{\it J. Hydrometeor.}, {\bf 5}, 516-531.
\url{https://doi.org/10.1175/1525-7541(2004)005\%3C0516:TUOSPA\%3E2.0.CO;2}

\end{description}
\end{document}




			



